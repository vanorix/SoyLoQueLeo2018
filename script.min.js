var imageURL,imgObj,stage,image,frameObj,frame,path,sharePath,frames=["images/marcos/transparente.png","images/marcos/Marco.png","images/marcos/ciencia-ficcion(final).png","images/marcos/cuento(final).png","images/marcos/historico(final).png","images/marcos/poesia(final).png","images/marcos/terror(final).png"],currentFrame=1,generateHeader=function(){var e=document.createElement("div");e.setAttribute("class","head"),e.setAttribute("id","head");var t=document.createElement("img");return t.setAttribute("src","images/Soy-Lo-Que-Leo.png"),t.setAttribute("id","headerImage"),e.appendChild(t),e},generateSelection=function(){var e=document.createElement("div");e.setAttribute("class","dropdown"),e.setAttribute("id","dropdown");var t=document.createElement("button");t.setAttribute("class","btn btn-secondary dropdown-toggle"),t.setAttribute("type","button"),t.setAttribute("data-toggle","dropdown"),t.setAttribute("aria-haspopup","true"),t.setAttribute("aria-expanded","false"),t.setAttribute("id","dropdown-toggle"),t.innerText="¿Cuál de estos géneros es tu favorito?";var a=document.createElement("div");a.setAttribute("id","dropdown-menu"),a.setAttribute("aria-labelledby","dropdown-toggle"),a.setAttribute("class","dropdown-menu");var n=document.createElement("button");n.setAttribute("class","dropdown-item"),n.setAttribute("type","button"),n.setAttribute("onclick","setFrame(1)"),n.innerText="Patria";var i=document.createElement("button");i.setAttribute("class","dropdown-item"),i.setAttribute("type","button"),i.setAttribute("onclick","setFrame(2)"),i.innerText="Ciencia Ficción";var r=document.createElement("button");r.setAttribute("class","dropdown-item"),r.setAttribute("type","button"),r.setAttribute("onclick","setFrame(3)"),r.innerText="Cuentos";var o=document.createElement("button");o.setAttribute("class","dropdown-item"),o.setAttribute("type","button"),o.setAttribute("onclick","setFrame(4)"),o.innerText="Historia";var d=document.createElement("button");d.setAttribute("class","dropdown-item"),d.setAttribute("type","button"),d.setAttribute("onclick","setFrame(5)"),d.innerText="Poesia";var s=document.createElement("button");return s.setAttribute("class","dropdown-item"),s.setAttribute("type","button"),s.setAttribute("onclick","setFrame(6)"),s.innerText="Terror",a.appendChild(n),a.appendChild(i),a.appendChild(r),a.appendChild(o),a.appendChild(d),a.appendChild(s),e.appendChild(t),e.appendChild(a),e},setFrame=function(e){currentFrame=e,initCanvas()},generateHome=function(){var e=document.createElement("div");e.setAttribute("class","body"),e.setAttribute("id","body");var t=document.createElement("div");t.setAttribute("class","panel"),t.setAttribute("id","panel");var a=document.createElement("a");a.setAttribute("id","buttonFacebook"),a.setAttribute("class","btn btn-facebook"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","uploadImageFB()"),a.innerHTML="<i class='fab fa-facebook-f'></i> &nbsp;Subir desde Facebook";document.createElement("br"),document.createElement("br");var n=document.createElement("label");n.setAttribute("class","upload"),document.documentElement.clientWidth<991?n.innerHTML="<i class='fas fa-camera'></i> &nbsp;Hazte una foto":n.innerHTML="<i class='fas fa-cloud-upload-alt'></i> &nbsp;Sube una foto";var i=document.createElement("input");return i.setAttribute("id","buttonUpload"),i.setAttribute("type","file"),i.setAttribute("accept","image/*"),i.setAttribute("capture","filesystem"),i.setAttribute("onchange","uploadImage(this)"),n.appendChild(i),t.appendChild(a),t.appendChild(n),e.appendChild(t),e},clearElement=function(e){for(var t=document.getElementById(e);t.hasChildNodes();)t.removeChild(t.firstChild)},fbLogin=function(){FB.login(function(e){console.log(e),"connected"===e.status&&FB.api("/me","GET",{fields:"picture.width(306).height(306)"},function(e){console.log(e),imageURL=e.picture.data.url,initCanvas()})},{scope:"email"})},postImageToFacebook=function(e){$.post("http://data-uri-to-img-url.herokuapp.com/images.json",{image:[{data_uri:e}]},function(e){console.log(e.url)})},dataURItoBlob=function(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var a=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new Blob([n],{type:a})},guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},dataURLtoFile=function(e,t){for(var a=e.split(","),n=a[0].match(/:(.*?);/)[1],i=atob(a[1]),r=i.length,o=new Uint8Array(r);r--;)o[r]=i.charCodeAt(r);return new File([o],t,{type:n})},shareImage=function(){var e=guid()+".png",t=dataURLtoFile(path,e);console.log(t),FB.ui({method:"share",href:window.location.href,title:"Soy lo que leo",picture:window.location.href,caption:"Soy lo que leo"},function(e){})},uploadImageFB=function(){fbLogin()},uploadImage=function(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){imageURL=e.target.result,initCanvas()},t.readAsDataURL(e.files[0])}},downloadImage=function(){var e=document.createElement("a"),t=dataURItoBlob(path);e.download="SoyLoQueLeo.png",e.href=URL.createObjectURL(t),document.body.appendChild(e),e.click(),document.body.removeChild(e),delete e},saveToServer=function(){var e={async:!0,crossDomain:!0,url:"https://4449e3a0.ngrok.io/api/save",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{img_data:path}};$.ajax(e).done(function(e){console.log(e)})},saveImage=function(){stage.find("Transformer").destroy(),layer.draw(),path=stage.toDataURL(),sharePath=window.location.href+path,console.log(dataURItoBlob(path)),console.log(sharePath),saveToServer(),console.log(path);var e=document.getElementById("buttons"),t=document.getElementById("SaveButton");e.removeChild(t);var a=document.createElement("a");a.setAttribute("id","DownloadButton"),a.setAttribute("class","btn btn-primary"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","downloadImage()"),a.innerHTML="<i class='fas fa-cloud-download-alt'></i> &nbsp;Descarga tu imagen";var n=document.createElement("a");n.setAttribute("id","ShareButton"),n.setAttribute("class","btn btn-primary"),n.setAttribute("href","javascript:;"),n.setAttribute("onclick","shareImage()"),n.innerHTML="<i class='fab fa-facebook-f'></i> &nbsp;Compartir en Facebook";var i=document.createElement("br");e.appendChild(a),e.appendChild(i),e.appendChild(n)},imageEditingLayout=function(){var e=document.createElement("div");e.setAttribute("class","body"),e.setAttribute("id","body");var t=document.createElement("div");t.setAttribute("class","panel");var a=document.createElement("div");a.setAttribute("class","thumb");var n=document.createElement("div");n.setAttribute("id","ImagePreview");var i=document.createElement("div");i.setAttribute("class","buttons"),i.setAttribute("id","buttons");var r=document.createElement("a");r.setAttribute("id","SaveButton"),r.setAttribute("class","btn btn-primary"),r.setAttribute("href","javascript:;"),r.setAttribute("onclick","saveImage()"),r.innerHTML="<i class='fas fa-save'></i> &nbsp;¡Listo!";document.createElement("br");var o=generateSelection(),d=document.createElement("br");return e.appendChild(o),e.appendChild(d),a.appendChild(n),i.appendChild(r),t.appendChild(a),t.appendChild(i),e.appendChild(t),e},initCanvas=function(){clearElement("main");var e=document.getElementById("main"),t=imageEditingLayout(),a=document.createElement("br"),n=document.createElement("br");e.appendChild(generateHeader()),e.appendChild(a),e.appendChild(n),e.appendChild(t),layer=new Konva.Layer,stage=new Konva.Stage({container:"ImagePreview",width:312,height:312}),imageObj=new Image,imageObj.onload=function(){image=document.documentElement.clientWidth<991?new Konva.Image({image:imageObj,y:34,x:279,width:240,height:245,draggable:!0,rotation:90}):new Konva.Image({image:imageObj,y:34,x:34,width:245,height:240,draggable:!0}),(frameObj=new Image).onload=function(){frame=new Konva.Image({image:frameObj,width:312,height:312}),layer.add(image),layer.add(frame),stage.add(layer);var e=new Konva.Transformer;layer.add(e),e.attachTo(image),layer.draw()},frameObj.src=frames[currentFrame]},imageObj.src=imageURL,imageObj.setAttribute("crossOrigin","anonymous"),console.log(imageURL)};!function(){var e=document.getElementById("main"),t=document.createElement("br"),a=document.createElement("br"),n=generateHeader(),i=generateHome();e.appendChild(n),e.appendChild(t),e.appendChild(a),e.appendChild(i)}();