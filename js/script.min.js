var imageURL,imgObj,stage,image,frameObj,frame,path,sharePath,frames=["images/marcos/transparente.png","images/marcos/Marco.png","images/marcos/ciencia-ficcion(final).png","images/marcos/cuento(final).png","images/marcos/historico(final).png","images/marcos/poesia(final).png","images/marcos/terror(final).png"],currentFrame=1,generateHeader=function(){var e=document.createElement("div");e.setAttribute("class","head"),e.setAttribute("id","head");var t=document.createElement("img");return t.setAttribute("src","images/Soy-Lo-Que-Leo.png"),t.setAttribute("id","headerImage"),e.appendChild(t),e},generateContest=function(){var e=document.createElement("div");e.setAttribute("class","contest");var t=document.createElement("h2");t.setAttribute("class","contest_title"),t.innerHTML="Participa en nuestro concurso:";var a=document.createElement("ul");a.setAttribute("class","favth-list-square");var n=document.createElement("li");n.innerHTML="<i class='fas fa-cloud-upload-alt'></i> Sube tu foto usando la aplicación.";var r=document.createElement("li");r.innerHTML="<i class='far fa-object-group'></i> Elige tu marco favorito y descárgala.";var i=document.createElement("li");i.innerHTML="<i class='fab fa-instagram'></i> Compartela en Instagram utilizando el hashtag <span class='hashtag'>#SoyLoQueLeo.</span>";var o=document.createElement("li");o.innerHTML="<i class='fas fa-tag'></i> Etiqueta las cuentas <a href='https://www.instagram.com/vicerdo/'>@Vicerdo</a> y <a href='https://www.instagram.com/tubiblioteca/'>@tubiblioteca</a>.";var d=document.createElement("p");return d.setAttribute("id","contest_paragraph"),d.innerHTML="La foto con más  \t&#34;likes&#34; gana una de nuestras obras literarias.<br><em>¡El ganador será anunciado a través de nuestras redes sociales!</em>.<br> <span style='color:#ED2024'>*Se sortearán dos libros cada día.</span>",a.appendChild(n),a.appendChild(r),a.appendChild(i),a.appendChild(o),e.appendChild(t),e.appendChild(a),e.appendChild(d),e},generateSelection=function(){var e=document.createElement("div");e.setAttribute("class","dropdown"),e.setAttribute("id","dropdown");var t=document.createElement("button");t.setAttribute("class","btn btn-secondary dropdown-toggle"),t.setAttribute("type","button"),t.setAttribute("data-toggle","dropdown"),t.setAttribute("aria-haspopup","true"),t.setAttribute("aria-expanded","false"),t.setAttribute("id","dropdown-toggle"),t.innerText="¿Cuál de estos géneros es tu favorito?";var a=document.createElement("div");a.setAttribute("id","dropdown-menu"),a.setAttribute("aria-labelledby","dropdown-toggle"),a.setAttribute("class","dropdown-menu");var n=document.createElement("button");n.setAttribute("class","dropdown-item"),n.setAttribute("type","button"),n.setAttribute("onclick","setFrame(1)"),n.innerText="Patria";var r=document.createElement("button");r.setAttribute("class","dropdown-item"),r.setAttribute("type","button"),r.setAttribute("onclick","setFrame(2)"),r.innerText="Ciencia ficción";var i=document.createElement("button");i.setAttribute("class","dropdown-item"),i.setAttribute("type","button"),i.setAttribute("onclick","setFrame(3)"),i.innerText="Cuentos";var o=document.createElement("button");o.setAttribute("class","dropdown-item"),o.setAttribute("type","button"),o.setAttribute("onclick","setFrame(4)"),o.innerText="Historia";var d=document.createElement("button");d.setAttribute("class","dropdown-item"),d.setAttribute("type","button"),d.setAttribute("onclick","setFrame(5)"),d.innerText="Poesía";var s=document.createElement("button");return s.setAttribute("class","dropdown-item"),s.setAttribute("type","button"),s.setAttribute("onclick","setFrame(6)"),s.innerText="Terror",a.appendChild(n),a.appendChild(r),a.appendChild(i),a.appendChild(o),a.appendChild(d),a.appendChild(s),e.appendChild(t),e.appendChild(a),e},setFrame=function(e){currentFrame=e,initCanvas()},generateHome=function(){var e=document.createElement("div");e.setAttribute("class","body"),e.setAttribute("id","body");var t=document.createElement("div");t.setAttribute("class","panel"),t.setAttribute("id","panel");var a=document.createElement("a");a.setAttribute("id","buttonFacebook"),a.setAttribute("class","btn btn-facebook"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","uploadImageFB()"),a.innerHTML="<i class='fab fa-facebook-f'></i> &nbsp;Subir desde Facebook";document.createElement("br"),document.createElement("br");var n=document.createElement("label");n.setAttribute("class","upload"),document.documentElement.clientWidth<991?n.innerHTML="<i class='fas fa-camera'></i> &nbsp;Hazte una foto":n.innerHTML="<i class='fas fa-cloud-upload-alt'></i> &nbsp;Sube una foto";var r=document.createElement("input");return r.setAttribute("id","buttonUpload"),r.setAttribute("type","file"),r.setAttribute("accept","image/*"),r.setAttribute("capture","filesystem"),r.setAttribute("onchange","uploadImage(this)"),n.appendChild(r),t.appendChild(a),t.appendChild(n),e.appendChild(t),e},clearElement=function(e){for(var t=document.getElementById(e);t.hasChildNodes();)t.removeChild(t.firstChild)},fbLogin=function(){FB.login(function(e){"connected"===e.status&&FB.api("/me","GET",{fields:"picture.width(306).height(306)"},function(e){imageURL=e.picture.data.url,initCanvas()})},{scope:"email"})},postImageToFacebook=function(e){$.post("http://data-uri-to-img-url.herokuapp.com/images.json",{image:[{data_uri:e}]},function(e){})},dataURItoBlob=function(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var a=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return new Blob([n],{type:a})},guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},dataURLtoFile=function(e,t){for(var a=e.split(","),n=a[0].match(/:(.*?);/)[1],r=atob(a[1]),i=r.length,o=new Uint8Array(i);i--;)o[i]=r.charCodeAt(i);return new File([o],t,{type:n})},shareImage=function(){var e=guid()+".png";dataURLtoFile(path,e);FB.ui({method:"share",href:window.location.href,title:"Soy lo que leo",picture:window.location.href,caption:"Soy lo que leo"},function(e){})},imageLoader=function(e){var t;t=(document.documentElement.clientWidth,{maxWidth:420,maxHeight:420,orientation:!0,crop:!0});loadImage(e,function(e){imageURL=e.toDataURL(),initCanvas()},t)},uploadImageFB=function(){fbLogin()},uploadImage=function(e){imageLoader(e.files[0])},downloadImage=function(){var e=document.createElement("a"),t=dataURItoBlob(path);e.download="SoyLoQueLeo.png",e.href=URL.createObjectURL(t),document.body.appendChild(e),e.click(),document.body.removeChild(e),delete e},saveToServer=function(){var e={async:!0,crossDomain:!0,url:"https://563a42be.ngrok.io/api/save",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{img_data:path}};$.ajax(e).done(function(e){})},saveImage=function(){stage.find("Transformer").destroy(),layer.draw(),path=stage.toDataURL(),sharePath=window.location.href+path,saveToServer();var e=document.getElementById("buttons"),t=document.getElementById("SaveButton");e.removeChild(t);var a=document.createElement("a");a.setAttribute("id","DownloadButton"),a.setAttribute("class","btn btn-primary"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","downloadImage()"),a.innerHTML="<i class='fas fa-cloud-download-alt'></i> &nbsp;Descarga tu imagen";var n=document.createElement("a");n.setAttribute("id","ShareButton"),n.setAttribute("class","btn btn-primary"),n.setAttribute("href","javascript:;"),n.setAttribute("onclick","shareImage()"),n.innerHTML="<i class='fab fa-facebook-f'></i> &nbsp;Compartir en Facebook";var r=document.createElement("br");e.appendChild(a),e.appendChild(r),e.appendChild(n)},imageEditingLayout=function(){var e=document.createElement("div");e.setAttribute("class","body"),e.setAttribute("id","body");var t=document.createElement("div");t.setAttribute("class","panel");var a=document.createElement("div");a.setAttribute("class","thumb");var n=document.createElement("div");n.setAttribute("id","ImagePreview");var r=document.createElement("div");r.setAttribute("class","buttons"),r.setAttribute("id","buttons");var i=document.createElement("a");i.setAttribute("id","SaveButton"),i.setAttribute("class","btn btn-primary"),i.setAttribute("href","javascript:;"),i.setAttribute("onclick","saveImage()"),i.innerHTML="<i class='fas fa-save'></i> &nbsp;¡Listo!";var o=document.createElement("a");o.setAttribute("id","reset"),o.setAttribute("class","btn btn-secundary"),o.setAttribute("onclick","location.reload()"),o.setAttribute("href","javascript:;"),o.innerText="Empezar denuevo";var d=document.createElement("br"),s=generateSelection(),c=document.createElement("br");return e.appendChild(s),e.appendChild(c),a.appendChild(n),r.appendChild(i),r.appendChild(d),r.appendChild(o),t.appendChild(a),t.appendChild(r),e.appendChild(t),e},initCanvas=function(){clearElement("main");var e=document.getElementById("main"),t=imageEditingLayout(),a=document.createElement("br"),n=document.createElement("br");e.appendChild(generateHeader()),e.appendChild(a),e.appendChild(n),e.appendChild(t),layer=new Konva.Layer,stage=new Konva.Stage({container:"ImagePreview",width:312,height:312}),imageObj=new Image,imageObj.onload=function(){image=document.documentElement.clientWidth<991?new Konva.Image({image:imageObj,y:34,x:34,width:245,height:245,draggable:!0}):new Konva.Image({image:imageObj,y:34,x:34,width:245,height:240,draggable:!0}),(frameObj=new Image).onload=function(){frame=new Konva.Image({image:frameObj,width:312,height:312}),layer.add(image),layer.add(frame),stage.add(layer);var e=new Konva.Transformer;layer.add(e),e.attachTo(image),layer.draw()},frameObj.src=frames[currentFrame]},imageObj.src=imageURL,imageObj.setAttribute("crossOrigin","anonymous")},dropHandler=function(e){if(console.log("File(s) dropped"),e.preventDefault(),e.dataTransfer.items){for(var t=0;t<e.dataTransfer.items.length;t++)if("file"===e.dataTransfer.items[t].kind){var a=e.dataTransfer.items[t].getAsFile();return imageLoader(a),console.log("... file["+t+"].name = "+a.name),0}}else for(t=0;t<e.dataTransfer.files.length;t++)return imageLoader(e.dataTransfer.files[t]),0;removeDragData(e)},dragOverHandler=function(e){console.log("File(s) in drop zone"),e.preventDefault()};!function(){var e=document.getElementById("main");e.setAttribute("ondrop","dropHandler(event)"),e.setAttribute("ondragover","dragOverHandler(event)");var t=document.createElement("br"),a=document.createElement("br"),n=document.createElement("br"),r=document.createElement("br"),i=generateHeader(),o=generateHome(),d=generateContest();o.appendChild(n),o.appendChild(r),o.appendChild(d),e.appendChild(i),e.appendChild(t),e.appendChild(a),e.appendChild(o)}();